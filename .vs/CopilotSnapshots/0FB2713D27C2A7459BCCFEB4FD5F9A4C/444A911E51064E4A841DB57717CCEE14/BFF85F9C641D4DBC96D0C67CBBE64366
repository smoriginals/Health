import { useState, useEffect } from "react"
import {
    Sheet,
    SheetTrigger,
    SheetContent,
    SheetHeader,
    SheetTitle,
} from "@/components/ui/sheet"

import { Input } from "@/components/ui/input"
import { Button } from "@/components/ui/button"

import {
    Search,
    HeartPulse,
    Pill,
    Activity,
    Send,
    Plus,
} from "lucide-react"

export default function AskGpt({ children, initialQuestion }) {
    const [query, setQuery] = useState("")
    const [messages, setMessages] = useState([])
    const [hasInitialized, setHasInitialized] = useState(false)

    const examples = [
        "What causes chest pain?",
        "Best exercises for back pain",
        "Foods for better immunity",
        "Symptoms of dehydration"
    ]

    const sendMessage = (text) => {
        if (!text) return

        setMessages((m) => [...m, { role: "user", text }])

        // placeholder reply
        setMessages((m) => [
            ...m,
            { role: "assistant", text: "HealthGPT response placeholder." }
        ])

        setQuery("")
    }

    const startNewChat = () => {
        setMessages([])
        setQuery("")
        setHasInitialized(false)
    }

    // eslint-disable-next-line react-hooks/set-state-in-effect
    useEffect(() => {
        if (initialQuestion && !hasInitialized) {
            setMessages([
                { role: "user", text: initialQuestion },
                { role: "assistant", text: "HealthGPT response placeholder." }
            ])
            setHasInitialized(true)
        }
    }, [initialQuestion, hasInitialized])


    return (
        <Sheet>
            <SheetTrigger asChild>
                {children}
            </SheetTrigger>

            <SheetContent
                side="bottom"
                className="flex h-full w-full flex-col p-0 sm:w-[420px] md:w-dvw"
            >
                {/* HEADER */}
                <SheetHeader className="border-b p-4">
                    <SheetTitle className="flex items-center justify-center gap-2 text-xl">
                        <HeartPulse size={20} />
                        Health GPT
                    </SheetTitle>
                </SheetHeader>

                {/* CHAT BODY */}
                <div className="flex-1 space-y-3 overflow-y-auto p-4">

                    {/* Example prompts */}
                    {messages.length === 0 && (
                        <div className=" space-y-2">
                            <p className="text-sm text-gray-500">
                                Try asking:
                            </p>

                            {examples.map((ex, i) => (
                                <button
                                    key={i}
                                    onClick={() => sendMessage(ex)}
                                    className="flex items-center gap-2 h-14 w-full text-left p-2 rounded-lg border hover:bg-gray-100"
                                >
                                    <Activity size={16} />
                                    {ex}
                                </button>
                            ))}
                        </div>
                    )}

                    {/* Messages */}
                    {messages.map((m, i) => (
                        <div
                            key={i}
                            className={`p-3 rounded-xl max-w-[80%]
                ${m.role === "user"
                                    ? "bg-black text-white ml-auto"
                                    : "bg-gray-100 text-black"}
              `}
                        >
                            {m.text}
                        </div>
                    ))}
                </div>

                {/* INPUT AREA */}
                <div className="flex items-center gap-2 border-t p-3">
                    <Button
                        className="h-10 w-10 rounded-full bg-gray-100 text-black hover:bg-gray-200"
                        onClick={startNewChat}
                        title="Start new chat"
                    >
                        <Plus />
                    </Button>

                    <Input
                        placeholder="Ask HealthGPT..."
                        className='h-12 rounded-full'
                        value={query}
                        onChange={(e) => setQuery(e.target.value)}
                        onKeyDown={(e) => {
                            if (e.key === "Enter") sendMessage(query)
                        }}
                    />

                    <Button
                        className="h-10 w-10 rounded-full bg-black text-white hover:bg-black/80"
                        onClick={() => sendMessage(query)}
                    >
                        <Send size={18} />
                    </Button>
                </div>
            </SheetContent>
        </Sheet>
    )
}